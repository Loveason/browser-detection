<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…·ç±»æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a9e;
        }
        .result-area {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 200px;
        }
        .canvas-display {
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æµè§ˆå™¨æŒ‡çº¹æ£€æµ‹å·¥å…·ç±»æµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•é‡æ„åçš„å·¥å…·ç±»åŠŸèƒ½ã€‚æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚</p>

    <div class="container">
        <!-- åŠ å¯†å·¥å…·æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ” CryptoUtils æµ‹è¯•</h3>
            <button class="test-button" onclick="testCrypto()">æµ‹è¯•åŠ å¯†åŠŸèƒ½</button>
            <div class="result-area" id="crypto-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <!-- Canvaså·¥å…·æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ¨ CanvasUtils æµ‹è¯•</h3>
            <button class="test-button" onclick="testCanvas()">æµ‹è¯•CanvasåŠŸèƒ½</button>
            <div class="result-area" id="canvas-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
            <canvas id="test-canvas" class="canvas-display" width="200" height="100" style="display:none;"></canvas>
        </div>

        <!-- WebGLå·¥å…·æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ–¥ï¸ WebGLUtils æµ‹è¯•</h3>
            <button class="test-button" onclick="testWebGL()">æµ‹è¯•WebGLåŠŸèƒ½</button>
            <div class="result-area" id="webgl-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
            <canvas id="webgl-canvas" class="canvas-display" width="300" height="200" style="display:none;"></canvas>
        </div>

        <!-- éŸ³é¢‘å·¥å…·æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ”Š AudioUtils æµ‹è¯•</h3>
            <button class="test-button" onclick="testAudio()">æµ‹è¯•éŸ³é¢‘åŠŸèƒ½</button>
            <div class="result-area" id="audio-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <!-- æµè§ˆå™¨å·¥å…·æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸŒ BrowserUtils æµ‹è¯•</h3>
            <button class="test-button" onclick="testBrowser()">æµ‹è¯•æµè§ˆå™¨åŠŸèƒ½</button>
            <div class="result-area" id="browser-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <!-- ç°ä»£æ”¶é›†å™¨æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“Š ModernCollector æµ‹è¯•</h3>
            <button class="test-button" onclick="testCollector()">æµ‹è¯•æ”¶é›†å™¨</button>
            <div class="result-area" id="collector-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <!-- ç»¼åˆæµ‹è¯• -->
    <div class="test-section full-width">
        <h3>ğŸš€ ç»¼åˆæ€§èƒ½æµ‹è¯•</h3>
        <button class="test-button" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="test-button" onclick="runPerformanceTest()">æ€§èƒ½æµ‹è¯•</button>
        <button class="test-button" onclick="clearAllResults()">æ¸…é™¤ç»“æœ</button>
        <div class="result-area" id="comprehensive-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹ç»¼åˆæµ‹è¯•...</div>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="status-display"></div>

    <!-- å¼•å…¥å·¥å…·ç±» -->
    <script src="/static/js/utils/crypto-utils.js"></script>
    <script src="/static/js/utils/canvas-utils.js"></script>
    <script src="/static/js/utils/webgl-utils.js"></script>
    <script src="/static/js/utils/audio-utils.js"></script>
    <script src="/static/js/utils/browser-utils.js"></script>
    <script src="/static/js/modern-fingerprint.js"></script>

    <script>
        // å·¥å…·å‡½æ•°
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }

        function updateResult(id, content) {
            const element = document.getElementById(id);
            element.innerHTML = content;
        }

        function appendResult(id, content) {
            const element = document.getElementById(id);
            element.innerHTML += content + '<br>';
            element.scrollTop = element.scrollHeight;
        }

        // æµ‹è¯•åŠ å¯†å·¥å…·
        async function testCrypto() {
            showStatus('æ­£åœ¨æµ‹è¯•CryptoUtils...', 'info');
            updateResult('crypto-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // æµ‹è¯•å­—ç¬¦ä¸²å“ˆå¸Œ
                const testString = 'Hello, Browser Fingerprint!';
                const hash = await CryptoUtils.hashString(testString);
                appendResult('crypto-result', `å­—ç¬¦ä¸²å“ˆå¸Œ: ${hash.substring(0, 32)}...`);

                // æµ‹è¯•ç®€å•å“ˆå¸Œ
                const simpleHash = CryptoUtils.simpleHash(testString);
                appendResult('crypto-result', `ç®€å•å“ˆå¸Œ: ${simpleHash}`);

                // æµ‹è¯•ç†µå€¼è®¡ç®—
                const entropy = CryptoUtils.calculateEntropy([1, 2, 3, 4, 5, 1, 2, 3]);
                appendResult('crypto-result', `ç†µå€¼: ${entropy.toFixed(4)}`);

                const endTime = performance.now();
                appendResult('crypto-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('CryptoUtilsæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('crypto-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('CryptoUtilsæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•Canvaså·¥å…·
        async function testCanvas() {
            showStatus('æ­£åœ¨æµ‹è¯•CanvasUtils...', 'info');
            updateResult('canvas-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // åˆ›å»ºCanvas
                const canvas = CanvasUtils.createCanvas(200, 100);
                appendResult('canvas-result', `Canvasåˆ›å»º: ${canvas.width}x${canvas.height}`);

                // ç»˜åˆ¶æµ‹è¯•å›¾æ¡ˆ
                const pattern = CanvasUtils.drawTestPattern(canvas);
                appendResult('canvas-result', `æµ‹è¯•å›¾æ¡ˆ: ${pattern.description}`);

                // åˆ†æåƒç´ 
                const analysis = CanvasUtils.analyzePixels(canvas);
                appendResult('canvas-result', `åƒç´ åˆ†æ: ${analysis.totalPixels}åƒç´ , ç†µå€¼: ${analysis.entropy?.toFixed(4)}`);

                // æ˜¾ç¤ºCanvas
                const testCanvas = document.getElementById('test-canvas');
                const ctx = testCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0, testCanvas.width, testCanvas.height);
                testCanvas.style.display = 'block';

                const endTime = performance.now();
                appendResult('canvas-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('CanvasUtilsæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('canvas-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('CanvasUtilsæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•WebGLå·¥å…·
        async function testWebGL() {
            showStatus('æ­£åœ¨æµ‹è¯•WebGLUtils...', 'info');
            updateResult('webgl-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // æ£€æµ‹æ”¯æŒ
                const support = WebGLUtils.detectSupport();
                appendResult('webgl-result', `WebGLæ”¯æŒ: ${support.basic ? 'æ˜¯' : 'å¦'}`);

                if (!support.basic) {
                    appendResult('webgl-result', 'âŒ WebGLä¸æ”¯æŒï¼Œè·³è¿‡æµ‹è¯•');
                    return;
                }

                // åˆ›å»ºä¸Šä¸‹æ–‡
                const canvas = CanvasUtils.createCanvas(300, 200);
                const gl = WebGLUtils.getContext(canvas);
                appendResult('webgl-result', `WebGLä¸Šä¸‹æ–‡: ${gl ? 'åˆ›å»ºæˆåŠŸ' : 'åˆ›å»ºå¤±è´¥'}`);

                if (gl) {
                    // æ”¶é›†åŸºç¡€ä¿¡æ¯
                    const basicInfo = WebGLUtils.collectBasicInfo(gl);
                    appendResult('webgl-result', `æ¸²æŸ“å™¨: ${basicInfo.renderer}`);
                    appendResult('webgl-result', `ä¾›åº”å•†: ${basicInfo.vendor}`);

                    // ç»˜åˆ¶çº¢è‰²çŸ©å½¢
                    const redResult = await WebGLUtils.drawRedRectangle(canvas);
                    appendResult('webgl-result', `çº¢è‰²çŸ©å½¢æŒ‡çº¹: ${redResult.fingerprint.substring(0, 16)}...`);

                    // æ˜¾ç¤ºCanvas
                    const webglCanvas = document.getElementById('webgl-canvas');
                    const ctx = webglCanvas.getContext('2d');
                    ctx.drawImage(canvas, 0, 0, webglCanvas.width, webglCanvas.height);
                    webglCanvas.style.display = 'block';
                }

                const endTime = performance.now();
                appendResult('webgl-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('WebGLUtilsæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('webgl-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('WebGLUtilsæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•éŸ³é¢‘å·¥å…·
        async function testAudio() {
            showStatus('æ­£åœ¨æµ‹è¯•AudioUtils...', 'info');
            updateResult('audio-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // æ£€æµ‹æ”¯æŒ
                const support = AudioUtils.detectSupport();
                appendResult('audio-result', `AudioContextæ”¯æŒ: ${support.basicSupport ? 'æ˜¯' : 'å¦'}`);

                if (!support.basicSupport) {
                    appendResult('audio-result', 'âŒ AudioContextä¸æ”¯æŒï¼Œè·³è¿‡æµ‹è¯•');
                    return;
                }

                // æ ¼å¼æ”¯æŒ
                const formats = AudioUtils.getFormatSupport();
                const supportedFormats = Object.keys(formats).filter(f => formats[f]);
                appendResult('audio-result', `æ”¯æŒæ ¼å¼: ${supportedFormats.join(', ')}`);

                // ä¸Šä¸‹æ–‡å±æ€§
                const contextProps = await AudioUtils.getContextProperties();
                appendResult('audio-result', `ä¸Šä¸‹æ–‡æŒ‡çº¹: ${contextProps.fingerprint.substring(0, 16)}...`);

                // è®¾å¤‡ä¿¡æ¯
                const deviceInfo = await AudioUtils.getDeviceInfo();
                appendResult('audio-result', `è®¾å¤‡ä¿¡æ¯: ${deviceInfo.info.audioInputCount || 0}è¾“å…¥, ${deviceInfo.info.audioOutputCount || 0}è¾“å‡º`);

                const endTime = performance.now();
                appendResult('audio-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('AudioUtilsæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('audio-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('AudioUtilsæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•æµè§ˆå™¨å·¥å…·
        async function testBrowser() {
            showStatus('æ­£åœ¨æµ‹è¯•BrowserUtils...', 'info');
            updateResult('browser-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // ç”¨æˆ·ä»£ç†
                const userAgent = BrowserUtils.getUserAgentInfo();
                appendResult('browser-result', `å¹³å°: ${userAgent.platform}`);

                // å±å¹•ä¿¡æ¯
                const screen = BrowserUtils.getScreenInfo();
                appendResult('browser-result', `å±å¹•: ${screen.width}x${screen.height}, ${screen.colorDepth}ä½è‰²æ·±`);

                // æµè§ˆå™¨ç±»å‹
                const browserType = BrowserUtils.detectBrowserType();
                appendResult('browser-result', `æµè§ˆå™¨: ${browserType.detected}`);

                // å­—ä½“ä¿¡æ¯
                const fonts = BrowserUtils.getFontInfo();
                appendResult('browser-result', `å­—ä½“æ•°é‡: ${fonts.count}`);

                // å­˜å‚¨æ”¯æŒ
                const storage = BrowserUtils.getStorageInfo();
                const storageTypes = Object.keys(storage).filter(s => storage[s]);
                appendResult('browser-result', `å­˜å‚¨æ”¯æŒ: ${storageTypes.join(', ')}`);

                const endTime = performance.now();
                appendResult('browser-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('BrowserUtilsæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('browser-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('BrowserUtilsæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•ç°ä»£æ”¶é›†å™¨
        async function testCollector() {
            showStatus('æ­£åœ¨æµ‹è¯•ModernCollector...', 'info');
            updateResult('collector-result', 'æ­£åœ¨æµ‹è¯•...');

            try {
                const startTime = performance.now();

                // åˆ›å»ºæ”¶é›†å™¨
                const collector = new ModernFingerprintCollector();
                appendResult('collector-result', 'æ”¶é›†å™¨åˆ›å»ºæˆåŠŸ');

                // æ”¶é›†æŒ‡çº¹
                appendResult('collector-result', 'å¼€å§‹æ”¶é›†æŒ‡çº¹...');
                const fingerprint = await collector.collectAll();

                appendResult('collector-result', `ä¸»æŒ‡çº¹: ${fingerprint.mainFingerprint.substring(0, 32)}...`);
                appendResult('collector-result', `åŸºç¡€æŒ‡çº¹: ${fingerprint.basic?.fingerprint?.substring(0, 16)}...`);
                appendResult('collector-result', `CanvasæŒ‡çº¹: ${fingerprint.canvas?.fingerprint?.substring(0, 16)}...`);
                appendResult('collector-result', `WebGLæŒ‡çº¹: ${fingerprint.webgl?.fingerprint?.substring(0, 16)}...`);
                appendResult('collector-result', `éŸ³é¢‘æŒ‡çº¹: ${fingerprint.audio?.fingerprint?.substring(0, 16)}...`);

                const endTime = performance.now();
                appendResult('collector-result', `âœ… æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                showStatus('ModernCollectoræµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                appendResult('collector-result', `âŒ é”™è¯¯: ${error.message}`);
                showStatus('ModernCollectoræµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            showStatus('æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            updateResult('comprehensive-result', 'å¼€å§‹ç»¼åˆæµ‹è¯•...\n');

            const tests = [
                { name: 'CryptoUtils', func: testCrypto },
                { name: 'CanvasUtils', func: testCanvas },
                { name: 'WebGLUtils', func: testWebGL },
                { name: 'AudioUtils', func: testAudio },
                { name: 'BrowserUtils', func: testBrowser },
                { name: 'ModernCollector', func: testCollector }
            ];

            const startTime = performance.now();
            let passedTests = 0;

            for (const test of tests) {
                try {
                    appendResult('comprehensive-result', `æ­£åœ¨æµ‹è¯• ${test.name}...`);
                    await test.func();
                    appendResult('comprehensive-result', `âœ… ${test.name} æµ‹è¯•é€šè¿‡`);
                    passedTests++;
                } catch (error) {
                    appendResult('comprehensive-result', `âŒ ${test.name} æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }

            const endTime = performance.now();
            appendResult('comprehensive-result', `\nğŸ“Š æµ‹è¯•æ€»ç»“:`);
            appendResult('comprehensive-result', `- æ€»æµ‹è¯•æ•°: ${tests.length}`);
            appendResult('comprehensive-result', `- é€šè¿‡æ•°: ${passedTests}`);
            appendResult('comprehensive-result', `- æˆåŠŸç‡: ${(passedTests / tests.length * 100).toFixed(1)}%`);
            appendResult('comprehensive-result', `- æ€»è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

            showStatus(`ç»¼åˆæµ‹è¯•å®Œæˆ (${passedTests}/${tests.length})`, passedTests === tests.length ? 'success' : 'error');
        }

        // æ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            showStatus('æ­£åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•...', 'info');
            updateResult('comprehensive-result', 'å¼€å§‹æ€§èƒ½æµ‹è¯•...\n');

            const iterations = 10;
            appendResult('comprehensive-result', `æµ‹è¯•å¾ªç¯æ¬¡æ•°: ${iterations}`);

            // æµ‹è¯•å“ˆå¸Œæ€§èƒ½
            const hashStartTime = performance.now();
            for (let i = 0; i < iterations; i++) {
                await CryptoUtils.hashString(`test-${i}`);
            }
            const hashEndTime = performance.now();
            const avgHashTime = (hashEndTime - hashStartTime) / iterations;
            appendResult('comprehensive-result', `å¹³å‡å“ˆå¸Œæ—¶é—´: ${avgHashTime.toFixed(2)}ms`);

            // æµ‹è¯•Canvasæ€§èƒ½
            const canvasStartTime = performance.now();
            for (let i = 0; i < iterations; i++) {
                const canvas = CanvasUtils.createCanvas(100, 50);
                CanvasUtils.drawTestPattern(canvas);
            }
            const canvasEndTime = performance.now();
            const avgCanvasTime = (canvasEndTime - canvasStartTime) / iterations;
            appendResult('comprehensive-result', `å¹³å‡Canvasæ—¶é—´: ${avgCanvasTime.toFixed(2)}ms`);

            appendResult('comprehensive-result', `âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ`);
            showStatus('æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success');
        }

        // æ¸…é™¤æ‰€æœ‰ç»“æœ
        function clearAllResults() {
            const resultIds = ['crypto-result', 'canvas-result', 'webgl-result', 'audio-result', 'browser-result', 'collector-result', 'comprehensive-result'];
            resultIds.forEach(id => updateResult(id, 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...'));
            
            // éšè—Canvas
            document.getElementById('test-canvas').style.display = 'none';
            document.getElementById('webgl-canvas').style.display = 'none';
            
            showStatus('æ‰€æœ‰ç»“æœå·²æ¸…é™¤', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('å·¥å…·ç±»æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
            
            // æ£€æŸ¥å·¥å…·ç±»æ˜¯å¦å·²åŠ è½½
            const requiredClasses = ['CryptoUtils', 'CanvasUtils', 'WebGLUtils', 'AudioUtils', 'BrowserUtils', 'ModernFingerprintCollector'];
            const missingClasses = requiredClasses.filter(cls => !window[cls]);
            
            if (missingClasses.length > 0) {
                showStatus(`ç¼ºå°‘å·¥å…·ç±»: ${missingClasses.join(', ')}`, 'error');
            } else {
                console.log('âœ… æ‰€æœ‰å·¥å…·ç±»å·²æˆåŠŸåŠ è½½');
            }
        });
    </script>
</body>
</html>
